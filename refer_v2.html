<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—Ä–∏—Ü—ã JSON</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .drop-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            transition: all 0.3s;
        }
        .drop-area.highlight {
            border-color: #007bff;
            background-color: #e9f7fe;
            transform: scale(1.02);
        }
        #file-input {
            display: none;
        }
        #load-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #load-button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            table-layout: fixed; /* –ü–æ–º–æ–≥–∞–µ—Ç —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */
        }
        th, td {
            border: 1px solid #ccc; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º #ccc */
            padding: 8px 12px;
            text-align: left;
            /* word-wrap: break-word; */ /* –ú–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
        }
         /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ */
        th:nth-child(1), td:nth-child(1) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö */
        th:nth-child(n+2):not(:last-child):not(:nth-last-child(1)):not(:nth-last-child(2)):not(:nth-last-child(3)),
        td:nth-child(n+2):not(:last-child):not(:nth-last-child(1)):not(:nth-last-child(2)):not(:nth-last-child(3)) {
            min-width: 80px;
            width: auto;
        }
        /* –®–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ –°—É–º–º–∞, –ú–∞–∫—Å–∏–º—É–º –∏ –∏—Ç–æ–≥–æ–≤—ã—Ö */
        th:nth-last-child(5), td:nth-last-child(5), /* –°—É–º–º–∞ */
        th:nth-last-child(4), td:nth-last-child(4), /* –ú–∞–∫—Å–∏–º—É–º */
        th:nth-last-child(3), td:nth-last-child(3), /* –°—Ä–µ–¥–Ω–µ–µ */
        th:nth-last-child(2), td:nth-last-child(2), /* –°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞ */
        th:nth-last-child(1), td:nth-last-child(1)  /* –†–∞–∑–Ω–∏—Ü–∞ –º–∞–∫—Å-–º–∏–Ω */
        {
             width: 100px;
             min-width: 100px;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
            position: sticky;
            top: 0;
            transition: background-color 0.2s;
            vertical-align: top; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ –≤–µ—Ä—Ö—É */
            height: 60px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th:hover {
            background-color: #e0e0e0;
        }
        th.sort-asc::after {
            content: " ‚ñ≤";
            font-size: 12px;
        }
        th.sort-desc::after {
            content: " ‚ñº";
            font-size: 12px;
        }
        .summary-row {
            font-weight: bold;
            background-color: #f5f5f5;
        }
        .controls {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .filter-group {
            display: inline-block;
            margin-right: 15px;
        }
        label {
            margin-right: 5px;
            font-weight: bold;
        }
        .filter-input {
            padding: 5px;
            width: 100px;
            border: 1px solid #ccc; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º #ccc */
            border-radius: 3px;
        }
        .info-text {
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }
        .max-value-display {
            font-weight: bold;
            color: #007bff;
        }
        .stats-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .stats-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background: white;
            border-radius: 5px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .no-data {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        .file-name {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 13px;
        }
        .highlight-cell {
            background-color: #e6f7ff;
            font-weight: bold;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Å—Ç—Ä–æ–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –∫–ª–∏–∫–Ω—É–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        .sort-by-row-highlight {
             background-color: #fff3cd !important; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º !important –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è */
             transition: background-color 0.3s ease;
        }
        .sort-by-row-highlight td:first-child::before {
            content: "üëâ ";
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—Ä–∏—Ü—ã JSON</h1>
        <div class="drop-area" id="drop-area">
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ JSON-—Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
            <input type="file" id="file-input" accept=".json">
            <button id="load-button">–í—ã–±—Ä–∞—Ç—å JSON-—Ñ–∞–π–ª</button>
            <p class="info-text">–û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª —Å –º–∞—Ç—Ä–∏—Ü–µ–π –∏ —Å–ø–∏—Å–∫–æ–º —Ñ–∞–π–ª–æ–≤ (files –∏–ª–∏ legend)</p>
        </div>
        <div class="controls" id="controls">
            <div class="filter-group">
                <label for="min-max-filter">–ú–∏–Ω. –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: </label>
                <input type="number" id="min-max-filter" class="filter-input" step="0.01" min="0" max="1" value="0">
                <span>(–º–∞–∫—Å. –∑–Ω–∞—á–µ–Ω–∏–µ: <span class="max-value-display" id="max-value-display">0.00</span>)</span>
            </div>
        </div>
        <div id="table-container">
            <div class="no-data">–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON-—Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
        </div>
        <div class="stats-container" id="stats-container" style="display: none;">
            <div class="stats-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ (—Ñ–∞–π–ª—ã –±–µ–∑ refer_)</div>
                    <div class="stat-value" id="total-rows">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫ (—Ñ–∞–π–ª—ã —Å refer_)</div>
                    <div class="stat-value" id="total-cols">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</div>
                    <div class="stat-value" id="avg-value">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</div>
                    <div class="stat-value" id="max-value">0.00</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const loadButton = document.getElementById('load-button');
            const tableContainer = document.getElementById('table-container');
            const controls = document.getElementById('controls');
            const minMaxFilter = document.getElementById('min-max-filter');
            const maxValueDisplay = document.getElementById('max-value-display');
            const statsContainer = document.getElementById('stats-container');
            let currentJsonData = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
            loadButton.addEventListener('click', function() {
                fileInput.click();
            });
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            fileInput.addEventListener('change', handleFileSelect);
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–æ–Ω—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            function highlight() {
                dropArea.classList.add('highlight');
            }
            function unhighlight() {
                dropArea.classList.remove('highlight');
            }
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop
            dropArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    handleFiles(files);
                }
            });
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length) {
                    handleFiles(files);
                }
            }
            function handleFiles(files) {
                const file = files[0];
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            currentJsonData = jsonData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                            processJsonData(jsonData);
                        } catch (error) {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ JSON: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ JSON-—Ñ–∞–π–ª.');
                }
            }
            function processJsonData(jsonData) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (!jsonData.matrix || (!jsonData.files && !jsonData.legend)) {
                    alert('JSON-—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª—è "matrix" –∏ ("files" –∏–ª–∏ "legend")');
                    return;
                }
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                controls.style.display = 'block';
                statsContainer.style.display = 'block';
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–æ–Ω—É –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                dropArea.style.display = 'none';
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
                buildTable(jsonData);
            }

            function buildTable(jsonData) {
                 // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–æ–π
                tableContainer.innerHTML = '';

                const matrix = jsonData.matrix;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º legend, –µ—Å–ª–∏ files –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                const files = jsonData.files || jsonData.legend;
                // –†–∞–∑–¥–µ–ª—è–µ–º —Ñ–∞–π–ª—ã –Ω–∞ –≥—Ä—É–ø–ø—ã
                const referFiles = [];
                const nonReferFiles = [];
                files.forEach(file => {
                    if (file.includes('refer_')) {
                        referFiles.push(file);
                    } else {
                        nonReferFiles.push(file);
                    }
                });

                // --- –í—ã—á–∏—Å–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ ---
                const referFileCount = referFiles.length;
                const columnSums = new Array(referFileCount + 2).fill(0); // +2 –¥–ª—è "–°—É–º–º–∞" –∏ "–ú–∞–∫—Å–∏–º—É–º"
                const columnValues = Array.from({ length: referFileCount + 2 }, () => []);

                nonReferFiles.forEach((nonReferFile, rowIndex) => {
                    const globalRowIndex = files.indexOf(nonReferFile);
                    if (globalRowIndex >= matrix.length) return;

                    let rowSum = 0;
                    let rowMax = -Infinity;

                    referFiles.forEach((referFile, colIndex) => {
                        const globalColIndex = files.indexOf(referFile);
                        if (globalColIndex >= matrix[globalRowIndex].length) return;

                        let value = matrix[globalRowIndex][globalColIndex];
                        if (value === null) value = 0;

                        rowSum += value;
                        if (value > rowMax) rowMax = value;

                        columnSums[colIndex] += value;
                        columnValues[colIndex].push(value);
                    });

                    // –°—É–º–º–∞
                    columnSums[referFileCount] += rowSum;
                    columnValues[referFileCount].push(rowSum);

                    // –ú–∞–∫—Å–∏–º—É–º
                    columnValues[referFileCount + 1].push(rowMax);
                    if (rowMax > columnSums[referFileCount + 1]) {
                        columnSums[referFileCount + 1] = rowMax; // –≠—Ç–æ –Ω–µ —Å—É–º–º–∞, –∞ —Ç–µ–∫—É—â–∏–π –º–∞–∫—Å–∏–º—É–º
                    }
                });

                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const averages = columnSums.map((sum, index) => {
                    return columnValues[index].length > 0 ? sum / columnValues[index].length : 0;
                });

                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ —Ä–∞–∑–Ω–∏—Ü—ã
                const averageDiffs = columnValues.map(values => {
                    if (values.length < 2) return 0;
                    let totalDiff = 0;
                    for (let i = 0; i < values.length - 1; i++) {
                        totalDiff += Math.abs(values[i] - values[i + 1]);
                    }
                    return totalDiff / (values.length - 1);
                });

                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º
                const maxMinDiffs = columnValues.map(values => {
                    if (values.length === 0) return 0;
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    return max - min;
                });
                // --- –ö–æ–Ω–µ—Ü –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ---

                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                const table = document.createElement('table');
                table.id = 'data-table';

                // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
                const fileHeader = document.createElement('th');
                fileHeader.textContent = '–§–∞–π–ª';
                fileHeader.dataset.sortKey = 'file';
                fileHeader.addEventListener('click', () => sortTable(table, 0));
                headerRow.appendChild(fileHeader);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å 'refer_'
                referFiles.forEach((referFile, colIndex) => {
                    const th = document.createElement('th');
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—É –∏–∑ refer_frame_1455.png
                    const fileName = referFile.split('/').pop();
                    let displayText = fileName;
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–∏—Ñ—Ä
                    const match = fileName.match(/refer_frame_(\d+)\.png/);
                    if (match) {
                        displayText = match[1];
                    } else {
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç, –µ—Å–ª–∏ —Ü–∏—Ñ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                        const numMatch = fileName.match(/(\d+)\.png/);
                        if (numMatch) {
                            displayText = numMatch[1];
                        }
                    }
                    th.textContent = displayText;
                    th.title = fileName;
                    th.dataset.sortKey = fileName;
                    th.dataset.columnType = 'refer';
                    // –ü–µ—Ä–µ–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ (—Å —É—á–µ—Ç–æ–º –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ '–§–∞–π–ª')
                    th.addEventListener('click', () => sortTable(table, colIndex + 1));
                    headerRow.appendChild(th);
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å—É–º–º—ã
                const sumHeader = document.createElement('th');
                sumHeader.textContent = '–°—É–º–º–∞';
                sumHeader.dataset.sortKey = 'sum';
                sumHeader.dataset.columnType = 'sum';
                sumHeader.addEventListener('click', () => sortTable(table, referFiles.length + 1));
                headerRow.appendChild(sumHeader);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–∞–∫—Å–∏–º—É–º–∞
                const maxHeader = document.createElement('th');
                maxHeader.textContent = '–ú–∞–∫—Å–∏–º—É–º';
                maxHeader.dataset.sortKey = 'max';
                maxHeader.dataset.columnType = 'max';
                maxHeader.addEventListener('click', () => sortTable(table, referFiles.length + 2));
                headerRow.appendChild(maxHeader);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∏—Ç–æ–≥–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                const avgHeader = document.createElement('th');
                avgHeader.textContent = '–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ';
                avgHeader.dataset.sortKey = 'average';
                avgHeader.addEventListener('click', () => sortTable(table, referFiles.length + 3));
                headerRow.appendChild(avgHeader);

                const diffHeader = document.createElement('th');
                diffHeader.textContent = '–°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞';
                diffHeader.dataset.sortKey = 'difference';
                diffHeader.addEventListener('click', () => sortTable(table, referFiles.length + 4));
                headerRow.appendChild(diffHeader);

                const maxMinDiffHeader = document.createElement('th');
                maxMinDiffHeader.textContent = '–†–∞–∑–Ω–∏—Ü–∞ (–º–∞–∫—Å-–º–∏–Ω)';
                maxMinDiffHeader.dataset.sortKey = 'max-min-diff';
                maxMinDiffHeader.addEventListener('click', () => sortTable(table, referFiles.length + 5));
                headerRow.appendChild(maxMinDiffHeader);

                thead.appendChild(headerRow);
                table.appendChild(thead);

                // –°–æ–∑–¥–∞–µ–º —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
                const tbody = document.createElement('tbody');
                // –•—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                const dataRows = [];

                // –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ–∞–π–ª—É –±–µ–∑ 'refer_'
                nonReferFiles.forEach((nonReferFile, rowIndex) => {
                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤
                    const globalRowIndex = files.indexOf(nonReferFile);
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –º–∞—Ç—Ä–∏—Ü—ã
                    if (globalRowIndex >= matrix.length) return;
                    const tr = document.createElement('tr');
                    tr.dataset.rowIndex = rowIndex; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞
                    const fileNameCell = document.createElement('td');
                    const fileName = nonReferFile.split('/').pop();
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, item_00001.png -> 00001)
                    let displayFileName = fileName;
                    const numMatch = fileName.match(/item_(\d+)\.png/);
                    if (numMatch) {
                        displayFileName = numMatch[1];
                    }
                    fileNameCell.innerHTML = `<span class="file-name">${displayFileName}</span>`;
                    fileNameCell.title = nonReferFile;
                    tr.appendChild(fileNameCell);

                    let rowSum = 0;
                    let rowMax = -Infinity;
                    let maxColIndex = -1;

                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ —Å 'refer_'
                    referFiles.forEach((referFile, colIndex) => {
                        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤
                        const globalColIndex = files.indexOf(referFile);
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –º–∞—Ç—Ä–∏—Ü—ã
                        if (globalColIndex >= matrix[globalRowIndex].length) return;
                        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã
                        let value = matrix[globalRowIndex][globalColIndex];
                        // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ null, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 0
                        if (value === null) {
                            value = 0;
                        }
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É–º–º–µ
                        rowSum += value;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º—É–º
                        if (value > rowMax) {
                            rowMax = value;
                            maxColIndex = colIndex;
                        }
                        // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫—É
                        const td = document.createElement('td');
                        td.textContent = value.toFixed(4); // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 4 –∑–Ω–∞–∫–æ–≤
                        td.dataset.value = value;
                        tr.appendChild(td);
                    });

                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å —Å—É–º–º–æ–π
                    const sumCell = document.createElement('td');
                    sumCell.textContent = rowSum.toFixed(4);
                    sumCell.dataset.value = rowSum;
                    tr.appendChild(sumCell);

                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å –º–∞–∫—Å–∏–º—É–º–æ–º
                    const maxCell = document.createElement('td');
                    maxCell.textContent = rowMax > -Infinity ? rowMax.toFixed(4) : 'N/A';
                    maxCell.dataset.value = rowMax > -Infinity ? rowMax : 0;
                    tr.appendChild(maxCell);

                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ —Å –∏—Ç–æ–≥–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    const avgCell = document.createElement('td');
                    avgCell.textContent = averages[rowIndex].toFixed(4);
                    avgCell.dataset.value = averages[rowIndex];
                    tr.appendChild(avgCell);

                    const diffCell = document.createElement('td');
                    diffCell.textContent = averageDiffs[rowIndex].toFixed(4);
                    diffCell.dataset.value = averageDiffs[rowIndex];
                    tr.appendChild(diffCell);

                    const maxMinDiffCell = document.createElement('td');
                    maxMinDiffCell.textContent = maxMinDiffs[rowIndex].toFixed(4);
                    maxMinDiffCell.dataset.value = maxMinDiffs[rowIndex];
                    tr.appendChild(maxMinDiffCell);

                    // –í—ã–¥–µ–ª—è–µ–º —è—á–µ–π–∫—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    if (maxColIndex >= 0) { // –£—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 1 –∏–∑-–∑–∞ –∫–æ–ª–æ–Ω–∫–∏ '–§–∞–π–ª'
                         // maxColIndex + 1 –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - '–§–∞–π–ª'
                        const cellToHighlight = tr.cells[maxColIndex + 1];
                        if(cellToHighlight) {
                             cellToHighlight.classList.add('highlight-cell');
                        }
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É –∏ –≤ –º–∞—Å—Å–∏–≤
                    tbody.appendChild(tr);
                    dataRows.push(tr);
                });
                table.appendChild(tbody);

                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                tableContainer.appendChild(table);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats(jsonData, nonReferFiles.length, referFiles.length);

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                minMaxFilter.addEventListener('input', () => {
                    const minMaxValue = parseFloat(minMaxFilter.value) || 0;
                    filterRows(table, minMaxValue);
                });

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                updateMaxValueDisplay(table);

                // --- –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ ---
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ tbody –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—Ç—Ä–æ–∫–µ
                tbody.addEventListener('click', function(event) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ —è—á–µ–π–∫–µ td, –∞ –Ω–µ –ø–æ —Å—Ç—Ä–æ–∫–µ –∏—Ç–æ–≥–æ–≤
                    if (event.target.tagName === 'TD') { // –£–±—Ä–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ summary-row
                        const clickedRow = event.target.closest('tr');
                        if (clickedRow) {
                             // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                            const rowIndex = parseInt(clickedRow.dataset.rowIndex, 10);
                            if (!isNaN(rowIndex)) {
                                sortByRow(table, rowIndex, jsonData, referFiles.length);
                            }
                        }
                    }
                });
                // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –§–£–ù–ö–¶–ò–û–ù–ê–õ–ê ---
            }

            // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø sortByRow ---
            function sortByRow(table, rowIndex, jsonData, referFileCount) {
                const matrix = jsonData.matrix;
                const files = jsonData.files || jsonData.legend;
                const referFiles = files.filter(file => file.includes('refer_'));
                const nonReferFiles = files.filter(file => !file.includes('refer_'));

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–∞
                if (rowIndex < 0 || rowIndex >= nonReferFiles.length) {
                    console.error("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:", rowIndex);
                    return;
                }

                const globalRowIndex = files.indexOf(nonReferFiles[rowIndex]);
                if (globalRowIndex === -1 || globalRowIndex >= matrix.length) {
                     console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –æ–Ω –≤–Ω–µ –º–∞—Ç—Ä–∏—Ü—ã:", rowIndex, globalRowIndex);
                     return;
                }


                // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è refer —Ñ–∞–π–ª–æ–≤)
                const rowData = [];
                referFiles.forEach((referFile, colIndex) => {
                    const globalColIndex = files.indexOf(referFile);
                    if (globalColIndex >= 0 && globalColIndex < matrix[globalRowIndex].length) {
                        let value = matrix[globalRowIndex][globalColIndex];
                        if (value === null) value = 0;
                        rowData.push({ value: value, colIndex: colIndex });
                    } else {
                        // –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º 0
                        rowData.push({ value: 0, colIndex: colIndex });
                    }
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –≤ —Å—Ç—Ä–æ–∫–µ (–æ—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É)
                rowData.sort((a, b) => a.value - b.value);
                const sortedColumnIndices = rowData.map(item => item.colIndex);

                // --- –ü–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ---
                const thead = table.querySelector('thead');
                const headerRow = thead.querySelector('tr');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∫—Ä–æ–º–µ '–§–∞–π–ª', '–°—É–º–º–∞', '–ú–∞–∫—Å–∏–º—É–º', –∏—Ç–æ–≥–æ–≤—ã–µ)
                const originalHeaders = Array.from(headerRow.querySelectorAll(
                    'th:not(:first-child):not(:nth-last-child(5)):not(:nth-last-child(4)):not(:nth-last-child(3)):not(:nth-last-child(2)):not(:nth-last-child(1))'
                ));
                const fileHeader = headerRow.querySelector('th:first-child');
                const sumHeader = headerRow.querySelector('th:nth-last-child(5)');
                const maxHeader = headerRow.querySelector('th:nth-last-child(4)');
                const avgHeader = headerRow.querySelector('th:nth-last-child(3)');
                const diffHeader = headerRow.querySelector('th:nth-last-child(2)');
                const maxMinDiffHeader = headerRow.querySelector('th:nth-last-child(1)');

                 // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö (refer —Ñ–∞–π–ª–æ–≤)
                 const headersToRemove = Array.from(headerRow.querySelectorAll(
                    'th:not(:first-child):not(:nth-last-child(5)):not(:nth-last-child(4)):not(:nth-last-child(3)):not(:nth-last-child(2)):not(:nth-last-child(1))'
                 ));
                 headersToRemove.forEach(h => h.remove());

                 // –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ
                 sortedColumnIndices.forEach(colIndex => {
                     if(originalHeaders[colIndex]) {
                          headerRow.insertBefore(originalHeaders[colIndex], sumHeader);
                     }
                 });


                // --- –ü–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö ---
                const tbody = table.querySelector('tbody');
                const dataRows = Array.from(tbody.querySelectorAll('tr')); // –í—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

                // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –¥–∞–Ω–Ω—ã—Ö
                dataRows.forEach(row => {
                     const globalRowIndexForRow = files.indexOf(nonReferFiles[parseInt(row.dataset.rowIndex, 10)]);
                     if(globalRowIndexForRow === -1 || globalRowIndexForRow >= matrix.length) return;

                     // –°–æ—Ö—Ä–∞–Ω—è–µ–º —è—á–µ–π–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–æ–º–µ '–§–∞–π–ª', '–°—É–º–º–∞', '–ú–∞–∫—Å–∏–º—É–º', –∏—Ç–æ–≥–æ–≤—ã–µ)
                     const dataCells = Array.from(row.querySelectorAll(
                        'td:not(:first-child):not(:nth-last-child(5)):not(:nth-last-child(4)):not(:nth-last-child(3)):not(:nth-last-child(2)):not(:nth-last-child(1))'
                     ));
                     const fileCell = row.querySelector('td:first-child');
                     const sumCell = row.querySelector('td:nth-last-child(5)');
                     const maxCell = row.querySelector('td:nth-last-child(4)');
                     const avgCell = row.querySelector('td:nth-last-child(3)');
                     const diffCell = row.querySelector('td:nth-last-child(2)');
                     const maxMinDiffCell = row.querySelector('td:nth-last-child(1)');

                     // –£–¥–∞–ª—è–µ–º —è—á–µ–π–∫–∏ –¥–∞–Ω–Ω—ã—Ö refer
                     dataCells.forEach(cell => cell.remove());

                     // –í—Å—Ç–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ
                     sortedColumnIndices.forEach(colIndex => {
                         if(dataCells[colIndex]) {
                              row.insertBefore(dataCells[colIndex], sumCell);
                         }
                     });
                });

                // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫–µ, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ ---
                // –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
                const allHighlightedCells = tbody.querySelectorAll('.highlight-cell');
                allHighlightedCells.forEach(cell => cell.classList.remove('highlight-cell'));

                // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏
                const targetRow = dataRows.find(r => parseInt(r.dataset.rowIndex, 10) === rowIndex);
                if (targetRow) {
                    // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ - —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤ sortedColumnIndices
                    const maxOriginalColIndex = rowData[rowData.length - 1].colIndex; // –ò–Ω–¥–µ–∫—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    // –ù–∞–π–¥–µ–º, –Ω–∞ –∫–∞–∫—É—é –ø–æ–∑–∏—Ü–∏—é –æ–Ω –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    const newMaxColPosition = sortedColumnIndices.indexOf(maxOriginalColIndex);
                    if (newMaxColPosition !== -1) {
                         // newMaxColPosition - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç 0 –¥–æ referFileCount-1)
                         // –£—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 1 –∏–∑-–∑–∞ –∫–æ–ª–æ–Ω–∫–∏ '–§–∞–π–ª'
                         const cellToHighlight = targetRow.cells[newMaxColPosition + 1];
                         if(cellToHighlight) {
                              cellToHighlight.classList.add('highlight-cell');
                         }
                    }
                }

                // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ç—Ä–æ–∫–∏ ---
                 // –°–Ω–∏–º–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
                 const previouslyHighlightedRow = tbody.querySelector('.sort-by-row-highlight');
                 if (previouslyHighlightedRow) {
                     previouslyHighlightedRow.classList.remove('sort-by-row-highlight');
                 }
                 // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                 if (targetRow) {
                      targetRow.classList.add('sort-by-row-highlight');
                 }

                 // --- –°–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º ---
                 // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —É –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                 table.querySelectorAll('thead th').forEach(header => {
                     header.classList.remove('sort-asc', 'sort-desc');
                 });
                 // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ñ–∏–ª—å—Ç—Ä, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
                 // (–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, —Ñ–∏–ª—å—Ç—Ä –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –∫–æ–ª–æ–Ω–æ–∫)
                 updateMaxValueDisplay(table); // –û–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            }
            // --- –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ---

            function updateStats(jsonData, totalRows, totalCols) {
                document.getElementById('total-rows').textContent = totalRows;
                document.getElementById('total-cols').textContent = totalCols;
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                let totalSum = 0;
                let totalCount = 0;
                let maxValue = 0;
                const matrix = jsonData.matrix;
                for (let i = 0; i < matrix.length; i++) {
                    for (let j = 0; j < matrix[i].length; j++) {
                        const value = matrix[i][j];
                        if (value !== null) {
                            totalSum += value;
                            totalCount++;
                            if (value > maxValue) {
                                maxValue = value;
                            }
                        }
                    }
                }
                const avgValue = totalCount > 0 ? totalSum / totalCount : 0;
                document.getElementById('avg-value').textContent = avgValue.toFixed(4);
                document.getElementById('max-value').textContent = maxValue.toFixed(4);
            }

            function updateMaxValueDisplay(table) {
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                let maxValue = 0;
                rows.forEach(row => {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∏—Ç–æ–≥–∞–º–∏
                    // if (row.classList.contains('summary-row')) return; // –£–±—Ä–∞–ª–∏, —Ç–∞–∫ –∫–∞–∫ –∏—Ç–æ–≥–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–µ –Ω–µ—Ç
                    const maxCell = row.cells[row.cells.length - 5]; // 5-—è —Å –∫–æ–Ω—Ü–∞ –∫–æ–ª–æ–Ω–∫–∞ - –º–∞–∫—Å–∏–º—É–º
                    const value = parseFloat(maxCell.dataset.value);
                    if (value > maxValue) {
                        maxValue = value;
                    }
                });
                maxValueDisplay.textContent = maxValue.toFixed(2);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                minMaxFilter.max = maxValue;
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–∞
                const currentFilterValue = parseFloat(minMaxFilter.value) || 0;
                filterRows(table, currentFilterValue);
            }

            function filterRows(table, minMaxValue) {
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                let visibleCount = 0;
                rows.forEach(row => {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∏—Ç–æ–≥–∞–º–∏
                    // if (row.classList.contains('summary-row')) return; // –£–±—Ä–∞–ª–∏
                    const maxCell = row.cells[row.cells.length - 5]; // 5-—è —Å –∫–æ–Ω—Ü–∞ –∫–æ–ª–æ–Ω–∫–∞ - –º–∞–∫—Å–∏–º—É–º
                    const value = parseFloat(maxCell.dataset.value);
                    if (value >= minMaxValue) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if(document.getElementById('total-rows')) {
                     document.getElementById('total-rows').textContent = visibleCount;
                }
            }

            function sortTable(table, columnIndex) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
                const headers = table.querySelectorAll('thead th');
                const th = headers[columnIndex];
                let direction = th.classList.contains('sort-asc') ? -1 : 1;

                // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —É –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                headers.forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                });

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                th.classList.add(direction === 1 ? 'sort-asc' : 'sort-desc');

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏
                rows.sort((a, b) => {
                    const aCell = a.cells[columnIndex];
                    const bCell = b.cells[columnIndex];
                    let aValue, bValue;

                    // –ï—Å–ª–∏ columnIndex === 0, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É –≤–Ω—É—Ç—Ä–∏ .file-name
                    if (columnIndex === 0) {
                        const aFileNameSpan = aCell.querySelector('.file-name');
                        const bFileNameSpan = bCell.querySelector('.file-name');
                        aValue = aFileNameSpan ? aFileNameSpan.textContent : aCell.textContent;
                        bValue = bFileNameSpan ? bFileNameSpan.textContent : bCell.textContent;
                        return direction * aValue.localeCompare(bValue, undefined, { numeric: true });
                    }
                    // –ò–Ω–∞—á–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
                    else {
                        aValue = parseFloat(aCell.dataset.value);
                        bValue = parseFloat(bCell.dataset.value);
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —á–∏—Å–ª–æ
                        if (isNaN(aValue)) aValue = -Infinity;
                        if (isNaN(bValue)) bValue = -Infinity;
                        return direction * (aValue - bValue);
                    }
                });

                // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                rows.forEach(row => tbody.appendChild(row));

                // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—Ç—Ä–æ–∫–µ, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
                 const previouslyHighlightedRow = tbody.querySelector('.sort-by-row-highlight');
                 if (previouslyHighlightedRow) {
                     previouslyHighlightedRow.classList.remove('sort-by-row-highlight');
                 }
            }

        });
    </script>
</body>
</html>